{"version":3,"file":"timeline.js","sourceRoot":"","sources":["../../src/interaction/timeline.ts"],"names":[],"mappings":";AAAA,OAAO,EAAE,QAAQ,EAAE,IAAI,EAAE,OAAO,EAAE,MAAM,YAAY,CAAC;AACrD,OAAO,EAAU,gBAAgB,EAAE,MAAM,eAAe,CAAC;AACzD,OAAO,eAAe,MAAM,QAAQ,CAAC;AAErC,OAAO,IAAI,MAAM,cAAc,CAAC;AAChC,OAAO,QAAQ,MAAM,wBAAwB,CAAC;AAE9C,IAAM,cAAc,GAAG,EAAE,CAAC;AAE1B,SAAS,sBAAsB,CAAC,WAAuC;IACrE,kBACE,IAAI,EAAE,KAAK,EACX,IAAI,EAAE,IAAI,EACV,MAAM,EAAE,cAAc,EACtB,OAAO,EAAE,CAAC,CAAC,EAAE,EAAE,EAAE,CAAC,EAAE,CAAC,CAAC,EACtB,KAAK,EAAE,CAAC,IACL,WAAW,EACd;AACJ,CAAC;AAED;IAAiD,uCAAe;IAAhE;QAAA,qEAwIC;QArIS,gBAAU,GAA2B,QAAQ,CAAC,KAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,KAAI,CAAC,EAAE,EAAE,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE,CAE5F,CAAC;;IAmIZ,CAAC;IA7HC,sDAAsD;IACxC,uCAAmB,GAAjC,UAAkC,UAAgB,EAAE,WAAuC;QACzF,IAAM,MAAM,GAA+B,sBAAsB,CAAC,WAAW,CAAC,CAAC;QAC/E,IAAM,UAAU,GAAG,MAAM,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC;QACrC,IAAM,aAAa,GAAG,MAAM,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC;QAExC,OAAO,IAAI,IAAI,CACb,UAAU,CAAC,IAAI,EACf,UAAU,CAAC,IAAI,GAAG,MAAM,CAAC,MAAM,GAAG,UAAU,GAAG,aAAa,EAC5D,UAAU,CAAC,KAAK,EAChB,MAAM,CAAC,MAAM,GAAG,UAAU,GAAG,aAAa,CAC3C,CAAC;IACJ,CAAC;IAEO,wCAAU,GAAlB,UAAmB,SAAkB;QACnC,IAAM,UAAU,GAAG,IAAI,CAAC,IAAI,CAAC,UAAU,CAAC;QACxC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC;QAC7B,UAAU,CAAC,OAAO,CAAC,UAAC,IAAI;YACtB,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC;QAC1B,CAAC,CAAC,CAAC;IACL,CAAC;IAES,mCAAK,GAAf;QACE,OAAO;IACT,CAAC;IAEO,4CAAc,GAAtB;QAAA,iBA6CC;QA5CC,IAAI,CAAC,MAAM,GAAG,sBAAsB,CAAC,IAAI,CAAC,oBAAoB,EAAgC,CAAC,CAAC;QAEhG,IAAM,SAAS,GAAG,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC;QAC/B,IAAA,gBAAsC,EAApC,cAAI,EAAE,oBAAO,EAAE,gBAAqB,CAAC;QACtC,IAAA,uBAAU,EAAE,yBAAY,EAAE,0BAAa,EAAE,wBAAW,CAAY;QACvE,IAAM,KAAK,GAAG,IAAI,CAAC,QAAQ,EAAE,CAAC;QAE9B,IAAM,KAAK,GAAG,IAAI,CAAC,QAAQ,EAAE,CAAC;QAC9B,IAAM,KAAK,GAAG,SAAS,CAAC,KAAK,GAAG,WAAW,GAAG,YAAY,CAAC;QAC3D,IAAM,cAAc,GAAG;YACrB,CAAC,EAAE,SAAS,CAAC,IAAI,GAAG,WAAW;YAC/B,CAAC,EAAE,KAAK,CAAC,EAAE,CAAC,CAAC,GAAG,UAAU;YAC1B,KAAK,OAAA;YACL,MAAM,EAAE,KAAK,CAAC,MAAM,GAAG,UAAU,GAAG,aAAa;YACjD,IAAI,MAAA;YACJ,KAAK,OAAA;YACL,KAAK,OAAA;YACL,kBAAkB,EAAE,KAAK,CAAC,CAAC,CAAC;SAC7B,CAAC;QAEF,IAAI,IAAI,CAAC,QAAQ,EAAE;YACjB,IAAI,CAAC,OAAO,CAAC,cAAc,EAAE,IAAI,CAAC,cAAc,CAAC,EAAE;gBACjD,IAAI,CAAC,cAAc,GAAG,cAAc,CAAC;gBACrC,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,cAAc,CAAC,CAAC;aACtC;SACF;aAAM;YACL,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,MAAM,CAAC,QAAQ,EAAE,CAAC;YAExC,IAAI,CAAC,QAAQ,GAAG,IAAI,QAAQ,YAC1B,SAAS,EAAE,IAAI,CAAC,SAAS,IACtB,cAAc,EACjB,CAAC;YACH,IAAI,CAAC,QAAQ,CAAC,EAAE,CAAC,eAAe,EAAE;gBAChC,KAAI,CAAC,eAAe,GAAG,KAAI,CAAC,IAAI,CAAC,UAAU,EAAE,CAAC,OAAO,CAAC;gBACtD,KAAI,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC;YACxB,CAAC,CAAC,CAAC;YACH,IAAI,CAAC,QAAQ,CAAC,EAAE,CAAC,aAAa,EAAE;gBAC9B,KAAI,CAAC,UAAU,CAAC,KAAI,CAAC,eAAe,CAAC,CAAC;YACxC,CAAC,CAAC,CAAC;YACH,IAAI,CAAC,QAAQ,CAAC,EAAE,CAAC,gBAAgB,EAAE,IAAI,CAAC,UAAU,CAAC,CAAC;YACpD,IAAI,CAAC,QAAQ,CAAC,EAAE,CAAC,gBAAgB,EAAE,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;YAC7D,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;YAC7C,IAAI,CAAC,cAAc,GAAG,cAAc,CAAC;SACtC;IACH,CAAC;IAEO,sCAAQ,GAAhB,UAAiB,IAAY;QAC3B,IAAM,UAAU,GAAG,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,CAAC;QAC5C,IAAI,CAAC,IAAI,CAAC,UAAU,CAAC,UAAU,CAAC,CAAC;IACnC,CAAC;IAEO,2CAAa,GAArB,UAAsB,IAAY;QACxB,IAAA,yBAAK,CAAiB;QACtB,IAAA,uCAAI,CAAiC;QAC7C,OAAO,IAAI,CAAC,MAAM,CAAC,UAAC,IAAI,IAAK,OAAA,IAAI,CAAC,KAAK,CAAC,KAAK,IAAI,EAApB,CAAoB,CAAC,CAAC;IACrD,CAAC;IAEO,sCAAQ,GAAhB;QACU,IAAA,yBAAK,CAAiB;QACtB,IAAA,uCAAI,CAAiC;QAC7C,OAAO,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,UAAC,IAAI,IAAK,OAAA,IAAI,CAAC,KAAK,CAAC,EAAX,CAAW,CAAC,CAAC,CAAC;IAC/C,CAAC;IAED,kBAAkB;IACR,oCAAM,GAAhB;QAAA,iBAsBC;QArBC,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC;QACxB,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,gBAAgB,CAAC,aAAa,EAAE;YAC3C,KAAI,CAAC,cAAc,EAAE,CAAC;QACxB,CAAC,CAAC,CAAC;QACH,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,gBAAgB,CAAC,YAAY,EAAE;YAC1C,KAAI,CAAC,cAAc,EAAE,CAAC;QACxB,CAAC,CAAC,CAAC;QACH,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,gBAAgB,CAAC,WAAW,EAAE;YACzC,IAAI,KAAI,CAAC,MAAM,CAAC,IAAI,IAAI,KAAI,CAAC,WAAW,EAAE;gBACxC,KAAI,CAAC,QAAQ,CAAC,MAAM,GAAG,IAAI,CAAC;gBAC5B,KAAI,CAAC,QAAQ,CAAC,gBAAgB,EAAE,CAAC;aAClC;YACD,KAAI,CAAC,WAAW,GAAG,KAAK,CAAC;QAC3B,CAAC,CAAC,CAAC;QACH,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,gBAAgB,CAAC,YAAY,EAAE;YAC1C,IAAI,KAAI,CAAC,MAAM,CAAC,IAAI,IAAI,KAAI,CAAC,WAAW,EAAE;gBACxC,KAAI,CAAC,QAAQ,CAAC,MAAM,GAAG,IAAI,CAAC;gBAC5B,KAAI,CAAC,QAAQ,CAAC,gBAAgB,EAAE,CAAC;aAClC;YACD,KAAI,CAAC,WAAW,GAAG,KAAK,CAAC;QAC3B,CAAC,CAAC,CAAC;IACL,CAAC;IAES,mCAAK,GAAf;QACE,IAAI,IAAI,CAAC,QAAQ,EAAE;YACjB,IAAI,CAAC,QAAQ,CAAC,OAAO,EAAE,CAAC;YACxB,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;SACtB;QACD,IAAI,IAAI,CAAC,SAAS,EAAE;YAClB,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;YAC5B,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;SACvB;IACH,CAAC;IACH,0BAAC;AAAD,CAAC,AAxID,CAAiD,eAAe,GAwI/D","sourcesContent":["import { throttle, uniq, isEqual } from '@antv/util';\nimport { IGroup, VIEW_LIFE_CIRCLE } from '../dependents';\nimport BaseInteraction from './base';\nimport { ITimeLineInteractionConfig } from '../interface/config';\nimport BBox from '../util/bbox';\nimport TimeLine from '../components/timeline';\n\nconst DEFAULT_HEIGHT = 40;\n\nfunction getValidTimeLineConfig(interaction: ITimeLineInteractionConfig): Required<ITimeLineInteractionConfig> {\n  return {\n    loop: false,\n    auto: true,\n    height: DEFAULT_HEIGHT,\n    padding: [0, 20, 0, 0],\n    speed: 2,\n    ...interaction,\n  };\n}\n\nexport default class TimeLineInteraction extends BaseInteraction {\n  private timeline: TimeLine;\n  private container: IGroup;\n  private onChangeFn: (tick: string) => void = throttle(this.onChange.bind(this), 20, { leading: true }) as (\n    tick: string\n  ) => void;\n  private config: ITimeLineInteractionConfig;\n  private originAnimation: any;\n  private timeLineConfig: any;\n  private firstRender: boolean;\n\n  /** TimeLineInteraction new 时的范围参数 interactionRange */\n  public static getInteractionRange(layerRange: BBox, interaction: ITimeLineInteractionConfig): BBox {\n    const config: ITimeLineInteractionConfig = getValidTimeLineConfig(interaction);\n    const paddingTop = config.padding[0];\n    const paddingBottom = config.padding[2];\n\n    return new BBox(\n      layerRange.minX,\n      layerRange.maxY - config.height - paddingTop - paddingBottom,\n      layerRange.width,\n      config.height + paddingTop + paddingBottom\n    );\n  }\n\n  private setAnimate(isAnimate: boolean) {\n    const geometries = this.view.geometries;\n    this.view.animate(isAnimate);\n    geometries.forEach((geom) => {\n      geom.animate(isAnimate);\n    });\n  }\n\n  protected start() {\n    return;\n  }\n\n  private renderTimeLine() {\n    this.config = getValidTimeLineConfig(this.getInteractionConfig() as ITimeLineInteractionConfig);\n\n    const viewRange = this.view.viewBBox;\n    const { loop, padding, speed } = this.config;\n    const [paddingTop, paddingRight, paddingBottom, paddingLeft] = padding;\n    const range = this.getRange();\n\n    const ticks = this.getTicks();\n    const width = viewRange.width - paddingLeft - paddingRight;\n    const timeLineConfig = {\n      x: viewRange.minX + paddingLeft,\n      y: range.tl.y + paddingTop,\n      width,\n      height: range.height - paddingTop - paddingBottom,\n      loop,\n      ticks,\n      speed,\n      defaultCurrentTick: ticks[0],\n    };\n\n    if (this.timeline) {\n      if (!isEqual(timeLineConfig, this.timeLineConfig)) {\n        this.timeLineConfig = timeLineConfig;\n        this.timeline.update(timeLineConfig);\n      }\n    } else {\n      this.container = this.canvas.addGroup();\n\n      this.timeline = new TimeLine({\n        container: this.container,\n        ...timeLineConfig,\n      });\n      this.timeline.on('timelinestart', () => {\n        this.originAnimation = this.view.getOptions().animate;\n        this.setAnimate(true);\n      });\n      this.timeline.on('timelineend', () => {\n        this.setAnimate(this.originAnimation);\n      });\n      this.timeline.on('timelinechange', this.onChangeFn);\n      this.timeline.on('timelineupdate', this.onChange.bind(this));\n      this.view.data(this.getFilterData(ticks[0]));\n      this.timeLineConfig = timeLineConfig;\n    }\n  }\n\n  private onChange(tick: string) {\n    const filterData = this.getFilterData(tick);\n    this.view.changeData(filterData);\n  }\n\n  private getFilterData(tick: string) {\n    const { field } = this.config;\n    const { data } = this.getViewLayer().options;\n    return data.filter((item) => item[field] === tick);\n  }\n\n  private getTicks() {\n    const { field } = this.config;\n    const { data } = this.getViewLayer().options;\n    return uniq(data.map((item) => item[field]));\n  }\n\n  /** 渲染 timeline */\n  protected render(): void {\n    this.firstRender = true;\n    this.view.on(VIEW_LIFE_CIRCLE.BEFORE_RENDER, () => {\n      this.renderTimeLine();\n    });\n    this.view.on(VIEW_LIFE_CIRCLE.BEFORE_PAINT, () => {\n      this.renderTimeLine();\n    });\n    this.view.on(VIEW_LIFE_CIRCLE.AFTER_PAINT, () => {\n      if (this.config.auto && this.firstRender) {\n        this.timeline.isPlay = true;\n        this.timeline.changePlayStatus();\n      }\n      this.firstRender = false;\n    });\n    this.view.on(VIEW_LIFE_CIRCLE.AFTER_RENDER, () => {\n      if (this.config.auto && this.firstRender) {\n        this.timeline.isPlay = true;\n        this.timeline.changePlayStatus();\n      }\n      this.firstRender = false;\n    });\n  }\n\n  protected clear(): void {\n    if (this.timeline) {\n      this.timeline.destroy();\n      this.timeline = null;\n    }\n    if (this.container) {\n      this.container.remove(true);\n      this.container = null;\n    }\n  }\n}\n"]}