{"version":3,"file":"base.js","sourceRoot":"","sources":["../../../src/components/label/base.ts"],"names":[],"mappings":"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","sourcesContent":["import { deepMix, each, map, isArray, get, clone, isNumber } from '@antv/util';\nimport ViewLayer from '../../base/view-layer';\nimport BaseComponent, { BaseComponentConfig } from '../base';\nimport {\n  IGroup,\n  IShape,\n  View,\n  Geometry,\n  Element,\n  Coordinate,\n  MappingDatum,\n  VIEW_LIFE_CIRCLE,\n  getDefaultAnimateCfg,\n  doAnimate,\n  ORIGIN,\n} from '../../dependents';\nimport { Label, TextStyle } from '../../interface/config';\nimport { LooseMap } from '../../interface/types';\nimport BBox from '../../util/bbox';\n\nexport interface LabelComponentConfig extends BaseComponentConfig {\n  layer: ViewLayer;\n  geometry: Geometry;\n  label: Label;\n}\n\nexport interface LabelComponentCtor<T extends LabelComponentConfig = LabelComponentConfig> {\n  new (config: T): LabelComponent;\n}\n\nexport default abstract class LabelComponent<L extends Label = Label> extends BaseComponent<LabelComponentConfig> {\n  protected layer: ViewLayer;\n  protected view: View;\n  protected geometry: Geometry;\n  protected coord: Coordinate;\n  protected options: L;\n  protected labels: IShape[];\n  private labelsCfgMap: Record<string, TextStyle> = {};\n  private lastLabelsCfgMap: Record<string, TextStyle> = {};\n\n  public getGeometry() {\n    return this.geometry;\n  }\n\n  public getLabels() {\n    return this.labels;\n  }\n\n  public show() {\n    this.container.show();\n  }\n\n  public hide() {\n    this.container.hide();\n  }\n\n  protected init(config: LabelComponentConfig) {\n    this.layer = config.layer;\n    const view = this.layer.view;\n    this.view = view;\n    this.geometry = config.geometry;\n    this.coord = view.getCoordinate();\n    this.options = deepMix(this.getDefaultOptions(), config.label);\n\n    const callback = () => {\n      this.clear();\n      this.render();\n    };\n    view.on(VIEW_LIFE_CIRCLE.AFTER_PAINT, callback);\n    this.addDisposable(() => {\n      view.off(VIEW_LIFE_CIRCLE.AFTER_PAINT, callback);\n    });\n  }\n\n  protected renderInner(group: IGroup) {\n    this.labels = [];\n    this.labelsCfgMap = {};\n\n    // 绘制 Label 图形\n    each(this.geometry.elements, (element: Element, elementIdx: number) => {\n      const labels = [].concat(this.drawLabelItem(group, element, elementIdx));\n      each(labels, (label, idx) => {\n        this.adjustLabel(label, element, idx);\n        if (!label.destroyed) {\n          this.labels.push(label);\n          this.labelsCfgMap[label.get('id')] = clone(label.attrs);\n        }\n      });\n    });\n\n    // 执行布局\n    this.layoutLabels(this.geometry, this.labels);\n\n    // 执行动画：参照 G2 Label 动画\n    const lastLabelsCfgMap = this.lastLabelsCfgMap;\n    const labelsCfgMap = this.labelsCfgMap;\n    const animateCfg = this.geometry.animateOption ? getDefaultAnimateCfg('label', this.coord) : false;\n    each(labelsCfgMap, (attrs: TextStyle, id: string) => {\n      const shape = group.findById(id) as IShape;\n      if (shape) {\n        if (lastLabelsCfgMap[id]) {\n          const oldAttrs = lastLabelsCfgMap[id];\n          // 图形发生更新\n          const updateAnimateCfg = get(animateCfg, 'update');\n          if (updateAnimateCfg) {\n            shape.attr(oldAttrs);\n            doAnimate(shape, updateAnimateCfg, {\n              toAttrs: {\n                ...attrs,\n              },\n              coordinate: this.coord,\n            });\n          }\n        } else {\n          // 新生成的 shape\n          const appearAnimateCfg = get(animateCfg, 'appear');\n          if (appearAnimateCfg) {\n            doAnimate(shape, appearAnimateCfg, {\n              toAttrs: {\n                ...shape.attr(),\n              },\n              coordinate: this.coord,\n            });\n          }\n        }\n      }\n      delete lastLabelsCfgMap[id];\n    });\n    each(lastLabelsCfgMap, (attrs: TextStyle, id) => {\n      // 移除\n      const leaveAnimateCfg = get(animateCfg, 'leave');\n      if (leaveAnimateCfg) {\n        const tempShape = group.addShape('text', {\n          attrs,\n          id,\n          name: 'label',\n        });\n        doAnimate(tempShape, leaveAnimateCfg, {\n          toAttrs: null,\n          coordinate: this.coord,\n        });\n      }\n    });\n    this.lastLabelsCfgMap = this.labelsCfgMap;\n  }\n\n  protected drawLabelText(group: IGroup, attrs: TextStyle, extraCfgs: LooseMap = {}): IShape {\n    return group.addShape('text', {\n      attrs,\n      ...extraCfgs,\n    });\n  }\n\n  protected drawLabelItem(group: IGroup, element: Element, elementIndex: number): IShape | IShape[] {\n    const model = element.getModel();\n    const items = [].concat(this.getLabelItemAttrs(element, elementIndex));\n    const offset = this.getDefaultOffset();\n    const offsetPoint = this.getLabelOffset();\n    return map(items, (attrs, index) => {\n      const position = {\n        x: attrs.x + offsetPoint.x,\n        y: attrs.y + offsetPoint.y,\n      };\n      const dataItem = isArray(model.mappingData) ? model.mappingData[index] : model.mappingData;\n      const id = this.getLabelId(dataItem);\n      return this.drawLabelText(\n        group,\n        { ...attrs, ...position },\n        {\n          id,\n          name: 'label',\n          offset,\n          element,\n          [ORIGIN]: dataItem,\n        }\n      );\n    });\n  }\n\n  /** 获取当前 Label 的 offset */\n  protected getDefaultOffset() {\n    return Number(this.options.offset);\n  }\n\n  /** 默认实现：获取当前 Label 的 offset 点：包括 offset、offsetX、offsetY */\n  protected getLabelOffset() {\n    const { offsetX, offsetY } = this.options;\n    return {\n      x: isNumber(offsetX) ? offsetX : 0,\n      y: isNumber(offsetY) ? offsetY : 0,\n    };\n  }\n\n  /** 通过指定方向和系数获取整体 offset 点 */\n  protected getLabelOffsetByDimAndFactor(dim: 'x' | 'y', factor: number) {\n    const { offsetX, offsetY } = this.options;\n    const offset = this.getDefaultOffset();\n    const offsetPoint = {\n      x: 0,\n      y: 0,\n    };\n    offsetPoint[dim] = offset * factor;\n    if (isNumber(offsetX)) {\n      offsetPoint.x += offsetX;\n    }\n    if (isNumber(offsetY)) {\n      offsetPoint.y += offsetY;\n    }\n    return offsetPoint;\n  }\n\n  /** 初始化默认全局配置 */\n  protected getDefaultOptions(): Partial<L> {\n    return {};\n  }\n\n  /** 获取绘制当前 Label 的属性配置 */\n  protected abstract getLabelItemAttrs(element: Element, idx: number): TextStyle | TextStyle[];\n\n  /** 在当前 Label 绘制之后的调整 */\n  protected abstract adjustLabel(label: IShape, element: Element, datumIdx: number): void;\n\n  /** 整理对所有 Labels 的布局调整 */\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  protected layoutLabels(geometry: Geometry, labels: IShape[]): void {\n    // empty\n  }\n\n  protected getLabelId(data: MappingDatum): string {\n    const origin = data._origin;\n    const type = this.geometry.type;\n    const xScale = this.geometry.getXScale();\n    const yScale = this.geometry.getYScale();\n    let labelId = this.geometry.getElementId(data);\n    if (type === 'line' || type === 'area') {\n      // 折线图以及区域图，一条线会对应一组数据，即多个 labels，为了区分这些 labels，需要在 line id 的前提下加上 x 字段值\n      labelId += ` ${origin[xScale.field]}`;\n    } else if (type === 'path') {\n      // path 路径图，无序，有可能存在相同 x 不同 y 的情况，需要通过 x y 来确定唯一 id\n      labelId += ` ${origin[xScale.field]}-${origin[yScale.field]}`;\n    }\n\n    return labelId;\n  }\n\n  protected getCoordinateBBox() {\n    const { coord } = this;\n    const { start, end } = coord;\n    return new BBox(Math.min(start.x, end.x), Math.min(start.y, end.y), coord.getWidth(), coord.getHeight());\n  }\n}\n\n// Label 组件注册\nconst LABEL_CONFIG_MAP: Record<string, LabelComponentCtor> = {};\n\nexport function registerLabelComponent(type: string, component: LabelComponentCtor) {\n  LABEL_CONFIG_MAP[type] = component;\n}\n\nexport function getLabelComponent(type: string): LabelComponentCtor {\n  return LABEL_CONFIG_MAP[type];\n}\n"]}