{"version":3,"file":"layer.js","sourceRoot":"","sources":["../../../src/plots/waterfall/layer.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Create By Bruce Too\n * On 2020-02-18\n */\nimport { deepMix, get, map, isArray, reduce, has, isFunction, isString, isObject } from '@antv/util';\nimport { registerPlotType } from '../../base/global';\nimport './geometry/shape/waterfall';\nimport { ElementOption, DataItem, LayerConfig } from '../..';\nimport ViewLayer, { ViewConfig } from '../../base/view-layer';\nimport { extractScale } from '../../util/scale';\nimport { AttributeCfg } from '@antv/attr';\nimport { getComponent } from '../../components/factory';\nimport * as EventParser from './event';\nimport './component/label/waterfall-label';\nimport DiffLabel, { DiffLabelcfg } from './component/label/diff-label';\nimport { LineStyle, TextStyle, GraphicStyle } from '../../interface/config';\nimport { getGeometryByType } from '../../util/view';\n\nconst G2_GEOM_MAP = {\n  waterfall: 'interval',\n};\n\nconst PLOT_GEOM_MAP = {\n  interval: 'waterfall',\n};\n\nexport const VALUE_FIELD = '$$value$$';\nexport const IS_TOTAL = '$$total$$';\nconst INDEX_FIELD = '$$index$$';\n\nexport interface WaterfallViewConfig extends ViewConfig {\n  showTotal?: {\n    visible: boolean;\n    label: string;\n  };\n  /** 差值label */\n  diffLabel?: {\n    visible: boolean;\n    style?: TextStyle;\n    formatter?: DiffLabelcfg['formatter'];\n  };\n  leaderLine?: {\n    visible: boolean;\n    style?: LineStyle;\n  };\n  color?:\n    | string\n    | { rising: string; falling: string; total?: string }\n    | ((type: string, value: number | null, values: number | number[], index: number) => string);\n  waterfallStyle?: GraphicStyle | ((...args: any[]) => GraphicStyle);\n}\n\nexport interface WaterfallLayerConfig extends WaterfallViewConfig, LayerConfig {}\n\nexport default class WaterfallLayer extends ViewLayer<WaterfallLayerConfig> {\n  public waterfall;\n  public type: string = 'watarfall';\n  public diffLabel;\n\n  public static getDefaultOptions(): Partial<WaterfallLayerConfig> {\n    return deepMix({}, super.getDefaultOptions(), {\n      legend: {\n        visible: false,\n        position: 'bottom',\n      },\n      label: {\n        visible: true,\n        adjustPosition: true,\n      },\n      /** 差值 label */\n      diffLabel: {\n        visible: true,\n      },\n      /** 迁移线 */\n      leaderLine: {\n        visible: true,\n      },\n      /** 显示总计 */\n      showTotal: {\n        visible: true,\n        label: '总计值',\n      },\n      waterfallStyle: {\n        /** 默认无描边 */\n        lineWidth: 0,\n      },\n      tooltip: {\n        visible: true,\n        shared: true,\n        showCrosshairs: false,\n        showMarkers: false,\n      },\n    });\n  }\n\n  public getOptions(props: WaterfallLayerConfig) {\n    const options = super.getOptions(props);\n    this.adjustLegendOptions(options);\n    this.adjustMeta(options);\n    return options;\n  }\n\n  public afterInit() {\n    super.afterInit();\n    const options = this.options;\n    if (options.diffLabel && options.diffLabel.visible) {\n      this.diffLabel = new DiffLabel({\n        view: this.view,\n        fields: [options.xField, options.yField, VALUE_FIELD],\n        formatter: options.diffLabel.formatter,\n        style: options.diffLabel.style,\n      });\n    } else if (this.diffLabel) {\n      this.diffLabel.clear();\n      this.diffLabel = null;\n    }\n  }\n\n  public afterRender() {\n    super.afterRender();\n    const options = this.options;\n    this.view.on('tooltip:change', (e) => {\n      const { items } = e;\n      for (let i = 0; i < items.length; i++) {\n        const item = items[i];\n        const data = get(item, 'data', {});\n        // 改变 tooltip 显示的name和value\n        item.name = data[options.xField];\n        item.value = data[options.yField];\n        if (!item.value && data[IS_TOTAL]) {\n          const values = data[VALUE_FIELD];\n          item.value = values[0] - values[1];\n        }\n        e.items[i] = item;\n      }\n    });\n    this.renderLabel();\n  }\n\n  protected renderLabel() {\n    const geometry = getGeometryByType(this.view, 'interval');\n    if (this.options.label && this.options.label.visible) {\n      this.doRenderLabel(geometry, {\n        type: 'waterfall',\n        ...this.options.label,\n      });\n    }\n  }\n\n  protected geometryParser(dim, type) {\n    if (dim === 'g2') {\n      return G2_GEOM_MAP[type];\n    }\n    return PLOT_GEOM_MAP[type];\n  }\n\n  protected interaction() {\n    this.setConfig('interactions', [{ type: 'tooltip' }, { type: 'active-region' }]);\n  }\n\n  protected addGeometry() {\n    const options = this.options;\n    const waterfall: ElementOption = {\n      type: 'interval',\n      position: {\n        fields: [options.xField, VALUE_FIELD],\n      },\n      shape: {\n        values: ['waterfall'],\n      },\n    };\n    waterfall.style = this._parseStyle();\n    waterfall.color = this._parseColor();\n    this.waterfall = waterfall;\n    if (this.options.tooltip && (this.options.tooltip.fields || this.options.tooltip.formatter)) {\n      this.geometryTooltip();\n    }\n    this.setConfig('geometry', waterfall);\n  }\n\n  protected processData(originData?: DataItem[]) {\n    const plotData = [];\n    const xField = this.options.xField;\n    const yField = this.options.yField;\n    map(originData, (dataItem, idx: number) => {\n      let value: any = dataItem[yField];\n      if (idx > 0) {\n        const prevValue = plotData[idx - 1][VALUE_FIELD];\n        if (isArray(prevValue)) {\n          value = [prevValue[1], dataItem[yField] + prevValue[1]];\n        } else {\n          value = [prevValue, dataItem[yField] + prevValue];\n        }\n      }\n      plotData.push({\n        ...dataItem,\n        [VALUE_FIELD]: value,\n        [INDEX_FIELD]: idx,\n      });\n    });\n    if (this.options.showTotal && this.options.showTotal.visible) {\n      const values = map(originData, (o) => o[yField]);\n      const totalValue = reduce(values, (p: number, n: number) => p + n, 0);\n      plotData.push({\n        [xField]: this.options.showTotal.label,\n        [yField]: null,\n        [VALUE_FIELD]: [totalValue, 0],\n        [INDEX_FIELD]: plotData.length,\n        [IS_TOTAL]: true,\n      });\n    }\n    return plotData;\n  }\n\n  protected scale() {\n    const { options } = this;\n    const scales = {};\n    /** 配置x-scale */\n    scales[options.xField] = { type: 'cat' };\n    if (has(options, 'xAxis')) {\n      extractScale(scales[options.xField], options.xAxis);\n    }\n    /** 配置y-scale */\n    scales[VALUE_FIELD] = {};\n    if (has(options, 'yAxis')) {\n      extractScale(scales[VALUE_FIELD], options.yAxis);\n    }\n    this.setConfig('scales', scales);\n  }\n\n  /** @override */\n  protected axis(): void {\n    const xAxis_parser = getComponent('axis', {\n      plot: this,\n      dim: 'x',\n    });\n    const yAxis_parser = getComponent('axis', {\n      plot: this,\n      dim: 'y',\n    });\n    const axesConfig = { fields: {} };\n    axesConfig.fields[this.options.xField] = xAxis_parser;\n    axesConfig.fields[VALUE_FIELD] = yAxis_parser;\n    /** 存储坐标轴配置项到config */\n    this.setConfig('axes', axesConfig);\n  }\n\n  protected coord() {\n    return;\n  }\n\n  protected parseEvents() {\n    super.parseEvents(EventParser);\n  }\n\n  protected geometryTooltip() {\n    this.waterfall.tooltip = {};\n    const tooltipOptions: any = this.options.tooltip;\n    if (tooltipOptions.fields) {\n      this.waterfall.tooltip.fields = tooltipOptions.fields;\n    }\n    if (tooltipOptions.formatter) {\n      this.waterfall.tooltip.callback = tooltipOptions.formatter;\n      if (!tooltipOptions.fields) {\n        this.waterfall.tooltip.fields = [this.options.xField, VALUE_FIELD];\n      }\n    }\n  }\n\n  /** 牵引线的样式注入到style中 */\n  private _parseStyle(): LineStyle {\n    const style = this.options.waterfallStyle;\n    const leaderLine = this.options.leaderLine;\n    const config: Record<string, any> = {};\n    if (isFunction(style)) {\n      config.callback = (...args) => {\n        return Object.assign({}, style(...args), { leaderLine });\n      };\n    } else {\n      config.cfg = { ...style, leaderLine };\n    }\n\n    return config;\n  }\n\n  private _parseColor(): AttributeCfg {\n    const options = this.options;\n    const { xField, yField } = this.options;\n    const config: any = {\n      fields: [xField, yField, VALUE_FIELD, INDEX_FIELD],\n    };\n    if (isFunction(options.color)) {\n      config.callback = options.color;\n    } else {\n      let risingColor = '#f4664a';\n      let fallingColor = '#30bf78';\n      let totalColor = 'rgba(0, 0, 0, 0.25)';\n      if (isString(options.color)) {\n        risingColor = fallingColor = totalColor = options.color;\n      } else if (isObject(options.color)) {\n        const { rising, falling, total } = options.color;\n        risingColor = rising;\n        fallingColor = falling;\n        totalColor = total;\n      }\n      config.callback = (type, value, values: number | number[], index: number) => {\n        if (index === this.options.data.length) {\n          return totalColor || (values[0] >= 0 ? risingColor : fallingColor);\n        }\n        return (isArray(values) ? values[1] - values[0] : values) >= 0 ? risingColor : fallingColor;\n      };\n    }\n    return config as AttributeCfg;\n  }\n\n  /** 复写 legend 配置, 瀑布图默认无legend */\n  private adjustLegendOptions(options): void {\n    const legendOptions = options.legend;\n    if (legendOptions) {\n      legendOptions.visible = false;\n    }\n  }\n\n  /** 复写 meta 配置 */\n  private adjustMeta(options): void {\n    const metaOptions = options.meta;\n    if (metaOptions) {\n      const valueFieldMeta = metaOptions ? metaOptions[options.yField] : {};\n      valueFieldMeta.alias = valueFieldMeta.alias || options.yField;\n      options.meta[VALUE_FIELD] = valueFieldMeta;\n    }\n  }\n}\n\nregisterPlotType('waterfall', WaterfallLayer);\n"]}