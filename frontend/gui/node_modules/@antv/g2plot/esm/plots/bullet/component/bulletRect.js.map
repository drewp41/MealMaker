{"version":3,"file":"bulletRect.js","sourceRoot":"","sources":["../../../../src/plots/bullet/component/bulletRect.ts"],"names":[],"mappings":"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","sourcesContent":["import { IGroup, View } from '../../../dependents';\nimport { find, map, get } from '@antv/util';\nimport { BulletAxis } from '../layer';\nimport BBox from '../../../util/bbox';\n\nexport interface BulletRectCfg {\n  /** 背景区间的区间范围 */\n  ranges: number[][];\n  yField: string;\n  rangeColors: string[];\n  rangeMax: number;\n  rangeSize: number;\n  axis?: BulletAxis;\n  style?: {\n    fill?: string;\n    stroke?: string;\n    strokeOpacity?: number;\n    [k: string]: any;\n  };\n}\n\nexport default class BulletRect {\n  private view: View;\n  private container: IGroup;\n  private cfg: BulletRectCfg;\n\n  constructor(view: View, cfg: BulletRectCfg) {\n    this.view = view;\n    this.cfg = cfg;\n    this._init();\n  }\n\n  /** 绘制辅助labels */\n  public draw() {\n    if (!this.view || this.view.destroyed) {\n      return;\n    }\n    this.container = this.view.middleGroup.addGroup();\n    this.container.set('name', 'rectGroups');\n    this.container.setZIndex(-100);\n    const geometry = this.getGeometry();\n    const shapes = map(geometry?.elements, (element) => element.shape);\n    for (let i = 0; i < this.cfg.ranges.length; i += 1) {\n      const shapeBox = shapes[i].getBBox();\n      const widthRatio = shapeBox.width / shapes[i].get('origin').data[this.cfg.yField];\n      this.drawRect(shapeBox, this.cfg.ranges[i] || [0, 1], widthRatio);\n    }\n    this.view.canvas.draw();\n  }\n\n  protected drawRect(box: BBox, ranges: number[], widthRatio: number) {\n    const options = this.cfg;\n    const rangeColors = options.rangeColors;\n    let xPos = box.minX;\n    const yPos = box.minY - (box.height * (options.rangeSize - 1)) / 2;\n    for (let i = 1; i < ranges.length; i += 1) {\n      const width = (ranges[i] - ranges[i - 1]) * options.rangeMax * widthRatio;\n      this.container\n        .addShape('rect', {\n          name: 'bullet-rect',\n          attrs: {\n            width,\n            height: box.height * options.rangeSize,\n            x: xPos,\n            y: yPos,\n            fill: rangeColors[(i - 1) % rangeColors.length],\n            fillOpacity: 0.25,\n          },\n        })\n        .set('zIndex', -1);\n      xPos += width;\n    }\n    if (options.axis && options.axis.visible) {\n      const tickInterval = options.rangeMax / (options.axis.tickCount - 1);\n      const rangeBox = new BBox(box.x, yPos, xPos, box.height * options.rangeSize);\n      this.drawBulletTicks(rangeBox, tickInterval, widthRatio);\n    }\n  }\n\n  /** 添加 ticks  */\n  protected drawBulletTicks(box: BBox, tickInterval: number, widthRatio: number) {\n    const options = this.cfg;\n    const ticksStyle = options.axis.style;\n    const tickCount = options.axis.tickCount;\n    const tickPosition = options.axis.position;\n    const tickOffset = get(ticksStyle, 'lineHeight', 0) - ticksStyle.fontSize / 2;\n    for (let tickIdx = 0; tickIdx < tickCount; tickIdx += 1) {\n      const x = box.minX + tickInterval * tickIdx * widthRatio;\n      let tickText = `${tickInterval * tickIdx}`;\n      if (options.axis.formatter) {\n        tickText = options.axis.formatter(tickText, tickIdx);\n      }\n      this.container.addShape('text', {\n        name: 'tick',\n        attrs: {\n          x,\n          y: tickPosition === 'before' ? box.minY - tickOffset : box.maxY + tickOffset,\n          text: `${tickText}`,\n          ...ticksStyle,\n        },\n      });\n      if (options.axis.tickLine && options.axis.tickLine.visible) {\n        const tickLineCfg = options.axis.tickLine;\n        if (tickIdx > 0 && tickIdx !== tickCount - 1) {\n          this.container\n            .addShape('path', {\n              attrs: {\n                path: [\n                  ['M', x, box.minY],\n                  ['L', x, box.maxY],\n                ],\n                ...tickLineCfg,\n              },\n            })\n            .set('zIndex', -1);\n        }\n      }\n    }\n  }\n\n  public clear() {\n    if (this.container) {\n      this.container.clear();\n    }\n  }\n\n  public destroy() {\n    if (this.container) {\n      this.container.remove();\n    }\n  }\n\n  private _init() {\n    this.view.on('beforerender', () => {\n      this.clear();\n    });\n\n    this.view.on('afterrender', () => {\n      this.draw();\n    });\n  }\n\n  private getGeometry() {\n    return find(this.view.geometries, (geometry) => geometry.type === 'interval');\n  }\n}\n"]}